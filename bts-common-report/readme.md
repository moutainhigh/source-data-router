dy_bts_search_rec_report zaful 搜索算法报表<br>
bin/kafka-console-consumer.sh --bootstrap-server 172.31.22.179:9092 --topic dy_bts_search_rec_report <br>
bin/kafka-topics.sh --zookeeper 172.31.61.192:2181,172.31.59.31:2181,172.31.62.153:2181,172.31.36.227:2181,172.31.40.73:2181 --create --topic dy_bts_search_rec_report --partitions 1 --replication-factor 1<br>
curl http://localhost:38195/report?configPath=/usr/local/services/bts-common-report-1.0-SNAPSHOT/bin/bts_zaful_search_rec_report.json <br>
curl http://localhost:38195/report/remove?reportName=BTS_ZAFUL_ORDER_SEARCH_REC <br>
curl http://localhost:38195/order/remove?reportName=BTS_ZAFUL_SEARCH_REC_ORDER <br>
curl http://localhost:38195/report/threads <br>
curl http://localhost:38195/order/threads <br>
curl http://localhost:38195/order?configPath=/usr/local/services/bts-common-report-1.0-SNAPSHOT/bin/bts_zaful_search_rec_report_order.json <br>
## 订单处理逻辑设计
1、消费 binlog，获取订单表、订单商品表数据，以站点名 + 订单 id 为 key 放入 redis，数据结构为 list，过滤掉订单状态大于 8 的订单，订单商品表 log 事件到达时，<br>
   1、订单状态为 0 ，计算下单商品数、GMV；<br>
   2、订单状态为1、8 时，计算销售额（分两个字段计算，1：加购数量*单价 goods_price*goods_number 2：计算 goods_pay_amount 字段 ）<br>
   3、在处理商品时，标记已处理的商品 <br>
   4、排除订单商品的更新事件 <br>
2、每次有事件到达，都循环一次缓存 list 根据 userid 和 sku 去 redis 缓存中查找，前缀通过报表名前缀查询，查询到埋点数据，则生成订单数据，将订单数据放入埋点中，发送到订单 topic；
   每次发送完成后，删除该 key，更新状态，重新设置 list，订单 topic 名字为：dy_log_cart_order_info; <br>
3、订单计算 job，配置项，zaful 统一指标，<br>
4、报表名称要求，zaful 报表名 必须包含 ZAFUL，GB 报表名称必须包含 GB,必须包含order，zaful有订单的指标必须包含下面：ZAFUL_ORDER，GB：GB_ORDER， APP 端报表必须以 _APP 结尾
## 部署信息
服务器IP：172.31.33.169 <br>
实际目录/data/apps/bts-common-report <br>
软连接目录/usr/local/services/bts-common-report <br>
项目应用部署到/usr/local/services/ 项目名称bts-common-report <br>
## bts zaful 搜索报表计算处理
```bash
curl --header "Content-Type: application/json" --request POST --data '{"globaleFilter":true,"globaleJsonFilters":[{"jsonPath":"$.glb_bts","valueFilter":null,"filterRule":"not_null"},{"jsonPath":"$.glb_d","valueFilter":"10013","filterRule":"equals"}],"valueEnum":null,"reportName":"BTS_ZAFUL_ORDER_SEARCH_REC","description":"zaful 搜索算法 ab 测试报表取数指标配置","reportFromKafka":{"fromStartOffset":false,"bootstrapServers":"172.31.35.194:9092,172.31.50.250:9092,172.31.63.112:9092","bootstrapGroupId":"dy_bts_search_rec_report","dataSourceTopic":"glbg-analitic","reportStrapServers":"172.31.35.194:9092,172.31.50.250:9092,172.31.63.112:9092","reportDataTopic":"dy_bts_search_rec_report"},"reportQuotaFieldConfigs":[{"quotaFieldName":"specimen","defaultValue":"_skip","extractValueJsonPath":"$.glb_od","jsonLogFilters":[{"jsonPath":"$.glb_plf","valueFilter":"pc","filterRule":"equals"},{"jsonPath":"$.glb_t","valueFilter":"ie","filterRule":"equals"},{"jsonPath":"$.glb_s","valueFilter":"b02","filterRule":"equals"},{"jsonPath":"$.glb_ubcta","valueFilter":null,"filterRule":"null"},{"jsonPath":"$.glb_filter.sort","valueFilter":"recommend","filterRule":"equals"}],"valueEnum":"quotaStringValueExtractFromLog","cacheData":false,"expireSeconds":1209600},{"quotaFieldName":"search_rec_uv","defaultValue":"_skip","extractValueJsonPath":"$.glb_od","jsonLogFilters":[{"jsonPath":"$.glb_plf","valueFilter":"pc","filterRule":"equals"},{"jsonPath":"$.glb_t","valueFilter":"ie","filterRule":"equals"},{"jsonPath":"$.glb_s","valueFilter":"b02","filterRule":"equals"},{"jsonPath":"$.glb_ubcta","valueFilter":null,"filterRule":"null"},{"jsonPath":"$.glb_filter.sort","valueFilter":"recommend","filterRule":"equals"}],"valueEnum":"quotaStringValueExtractFromLog","cacheData":false,"expireSeconds":1209600},{"quotaFieldName":"search_rec_pv","defaultValue":0,"extractValueJsonPath":"$.glb_od","jsonLogFilters":[{"jsonPath":"$.glb_plf","valueFilter":"pc","filterRule":"equals"},{"jsonPath":"$.glb_t","valueFilter":"ie","filterRule":"equals"},{"jsonPath":"$.glb_s","valueFilter":"b02","filterRule":"equals"},{"jsonPath":"$.glb_ubcta","valueFilter":null,"filterRule":"null"},{"jsonPath":"$.glb_filter.sort","valueFilter":"recommend","filterRule":"equals"}],"valueEnum":"countOneWithFilter","cacheData":false,"expireSeconds":1209600},{"quotaFieldName":"good_exp_uv","defaultValue":"_skip","extractValueJsonPath":"$.glb_od","jsonLogFilters":[{"jsonPath":"$.glb_plf","valueFilter":"pc","filterRule":"equals"},{"jsonPath":"$.glb_t","valueFilter":"ie","filterRule":"equals"},{"jsonPath":"$.glb_s","valueFilter":"b02","filterRule":"equals"},{"jsonPath":"$.glb_filter.sort","valueFilter":"recommend","filterRule":"equals"},{"jsonPath":"$.glb_pm","valueFilter":"mp","filterRule":"equals"}],"valueEnum":"quotaStringValueExtractFromLog","cacheData":false,"expireSeconds":1209600},{"quotaFieldName":"good_exp_pv","defaultValue":0,"extractValueJsonPath":"$.glb_ubcta","jsonLogFilters":[{"jsonPath":"$.glb_plf","valueFilter":"pc","filterRule":"equals"},{"jsonPath":"$.glb_t","valueFilter":"ie","filterRule":"equals"},{"jsonPath":"$.glb_s","valueFilter":"b02","filterRule":"equals"},{"jsonPath":"$.glb_filter.sort","valueFilter":"recommend","filterRule":"equals"},{"jsonPath":"$.glb_pm","valueFilter":"mp","filterRule":"equals"}],"valueEnum":"countListWithFilter","cacheData":false,"expireSeconds":1209600},{"quotaFieldName":"good_cli_pv","defaultValue":0,"extractValueJsonPath":"$.glb_ubcta","jsonLogFilters":[{"jsonPath":"$.glb_s","valueFilter":"b02","filterRule":"equals"},{"jsonPath":"$.glb_plf","valueFilter":"pc","filterRule":"equals"},{"jsonPath":"$.glb_pm","valueFilter":"mp","filterRule":"equals"},{"jsonPath":"$.glb_filter.sort","valueFilter":"recommend","filterRule":"equals"},{"jsonPath":"$.glb_t","valueFilter":"ic","filterRule":"equals"},{"jsonPath":"$.glb_x","valueFilter":"sku,addtobag","filterRule":"contains"},{"jsonPath":"$.glb_ubcta.sckw","valueFilter":null,"filterRule":"not_null"}],"valueEnum":"countOneWithFilter","cacheData":false,"expireSeconds":1209600},{"quotaFieldName":"good_cli_uv","defaultValue":"_skip","extractValueJsonPath":"$.glb_od","jsonLogFilters":[{"jsonPath":"$.glb_s","valueFilter":"b02","filterRule":"equals"},{"jsonPath":"$.glb_plf","valueFilter":"pc","filterRule":"equals"},{"jsonPath":"$.glb_pm","valueFilter":"mp","filterRule":"equals"},{"jsonPath":"$.glb_filter.sort","valueFilter":"recommend","filterRule":"equals"},{"jsonPath":"$.glb_t","valueFilter":"ic","filterRule":"equals"},{"jsonPath":"$.glb_x","valueFilter":"sku,addtobag","filterRule":"contains"},{"jsonPath":"$.glb_ubcta.sckw","valueFilter":null,"filterRule":"not_null"}],"valueEnum":"quotaStringValueExtractFromLog","cacheData":false,"expireSeconds":1209600},{"quotaFieldName":"good_cart_uv","defaultValue":"_skip","extractValueJsonPath":"$.glb_od","jsonLogFilters":[{"jsonPath":"$.glb_plf","valueFilter":"pc","filterRule":"equals"},{"jsonPath":"$.glb_ubcta.sckw","valueFilter":null,"filterRule":"not_null"},{"jsonPath":"$.glb_t","valueFilter":"ic","filterRule":"equals"},{"jsonPath":"$.glb_ubcta.fmd","valueFilter":"mp","filterRule":"equals"},{"jsonPath":"$.glb_ubcta.sort","valueFilter":"recommend","filterRule":"equals"},{"jsonPath":"$.glb_x","valueFilter":"ADT","filterRule":"equals"}],"valueEnum":"quotaStringValueExtractFromLog","cacheData":false,"expireSeconds":1209600},{"quotaFieldName":"good_cart_num","defaultValue":0,"extractValueJsonPath":"$.glb_skuinfo.pam","jsonLogFilters":[{"jsonPath":"$.glb_plf","valueFilter":"pc","filterRule":"equals"},{"jsonPath":"$.glb_ubcta.sckw","valueFilter":null,"filterRule":"not_null"},{"jsonPath":"$.glb_t","valueFilter":"ic","filterRule":"equals"},{"jsonPath":"$.glb_ubcta.fmd","valueFilter":"mp","filterRule":"equals"},{"jsonPath":"$.glb_ubcta.sort","valueFilter":"recommend","filterRule":"equals"},{"jsonPath":"$.glb_x","valueFilter":"ADT","filterRule":"equals"}],"valueEnum":"quotaIntValueExtractFromLog","cacheData":true,"expireSeconds":1209600},{"quotaFieldName":"good_cart_num","defaultValue":0,"extractValueJsonPath":"$.glb_skuinfo.pam","jsonLogFilters":[{"jsonPath":"$.glb_plf","valueFilter":"pc","filterRule":"equals"},{"jsonPath":"$.glb_ubcta.sckw","valueFilter":null,"filterRule":"not_null"},{"jsonPath":"$.glb_t","valueFilter":"ic","filterRule":"equals"},{"jsonPath":"$.glb_ubcta.fmd","valueFilter":"mp","filterRule":"equals"},{"jsonPath":"$.glb_ubcta.sort","valueFilter":"recommend","filterRule":"equals"},{"jsonPath":"$.glb_x","valueFilter":"ADT","filterRule":"equals"}],"valueEnum":"quotaIntValueExtractFromLog","cacheData":true,"expireSeconds":1209600},{"quotaFieldName":"timestamp","defaultValue":0,"extractValueJsonPath":"$.timestamp","jsonLogFilters":[],"valueEnum":"quotaLongValueExtractFromLog","cacheData":false,"expireSeconds":1209600}],"reportDefaultValues":{"bts":{"versionid":"_skip","planid":"_skip","bucketid":"_skip"},"good_cli_uv":"_skip","good_order_num":0,"good_cli_pv":0,"sales_amount":0,"good_cart_num":0,"good_paid_num":0,"good_cart_uv":"_skip","gmv":0,"search_rec_uv":"_skip","good_exp_uv":"_skip","pay_uv":"_skip","specimen":"_skip","search_rec_pv":0,"good_order_uv":"_skip","good_exp_pv":0,"timestamp":0}}' http://localhost:38195/report/json
curl --header "Content-Type: application/json" --request POST --data '{"globaleFilter":true,"globaleJsonFilters":[{"jsonPath":"$.glb_bts","valueFilter":null,"filterRule":"not_null"},{"jsonPath":"$.glb_d","valueFilter":"10013","filterRule":"equals"},{"jsonPath":"$.glb_ubcta.sort","valueFilter":"recommend","filterRule":"equals"},{"jsonPath":"$.glb_ubcta.fmd","valueFilter":"mp","filterRule":"equals"},{"jsonPath":"$.glb_plf","valueFilter":"pc","filterRule":"equals"},{"jsonPath":"$.glb_ubcta.sckw","valueFilter":null,"filterRule":"not_null"},{"jsonPath":"$.glb_t","valueFilter":"ic","filterRule":"equals"},{"jsonPath":"$.glb_x","valueFilter":"ADT","filterRule":"equals"}],"valueEnum":null,"reportName":"BTS_ZAFUL_SEARCH_REC_ORDER","description":"zaful 搜索算法 ab 测试报表取数指标配置,订单指标","reportFromKafka":{"fromStartOffset":false,"bootstrapServers":"172.31.35.194:9092,172.31.50.250:9092,172.31.63.112:9092","bootstrapGroupId":"dy_bts_zaful_search_rec_order","dataSourceTopic":"dy_log_cart_order_info","reportStrapServers":"172.31.35.194:9092,172.31.50.250:9092,172.31.63.112:9092","reportDataTopic":"dy_bts_search_rec_report"},"reportQuotaFieldConfigs":[{"quotaFieldName":"good_order_num","defaultValue":0,"extractValueJsonPath":"$.db_order_info.goods_num","jsonLogFilters":[{"jsonPath":"$.db_order_info.order_status","valueFilter":"0","filterRule":"equals"},{"jsonPath":"$.db_order_info.order_data","valueFilter":null,"filterRule":"false"}],"valueEnum":"quotaIntValueExtractFromLog","cacheData":false,"expireSeconds":1209600},{"quotaFieldName":"good_order_uv","defaultValue":"_skip","extractValueJsonPath":"$.glb_od","jsonLogFilters":[{"jsonPath":"$.db_order_info.order_status","valueFilter":"0","filterRule":"equals"},{"jsonPath":"$.db_order_info.order_data","valueFilter":null,"filterRule":"false"}],"valueEnum":"quotaStringValueExtractFromLog","cacheData":false,"expireSeconds":1209600},{"quotaFieldName":"gmv","defaultValue":0,"extractValueJsonPath":"$.db_order_info.gmv","jsonLogFilters":[{"jsonPath":"$.db_order_info.order_status","valueFilter":"0","filterRule":"equals"},{"jsonPath":"$.db_order_info.order_data","valueFilter":null,"filterRule":"false"}],"valueEnum":"quotaIntValueExtractFromLog","cacheData":false,"expireSeconds":1209600},{"quotaFieldName":"good_paid_num","defaultValue":0,"extractValueJsonPath":"$.db_order_info.goods_num","jsonLogFilters":[],"valueEnum":"quotaIntValueExtractFromLog","cacheData":false,"expireSeconds":1209600},{"quotaFieldName":"pay_uv","defaultValue":"_skip","extractValueJsonPath":"$.glb_od","jsonLogFilters":[{"jsonPath":"$.db_order_info.order_data","valueFilter":null,"filterRule":"false"},{"jsonPath":"$.db_order_info.order_status","valueFilter":"1,8","filterRule":"or"}],"valueEnum":"quotaStringValueExtractFromLog","cacheData":false,"expireSeconds":1209600},{"quotaFieldName":"sales_amount","defaultValue":0,"extractValueJsonPath":"$.db_order_info.gmv","jsonLogFilters":[{"jsonPath":"$.db_order_info.order_data","valueFilter":null,"filterRule":"false"},{"jsonPath":"$.db_order_info.order_status","valueFilter":"1,8","filterRule":"or"}],"valueEnum":"quotaIntValueExtractFromLog","cacheData":false,"expireSeconds":1209600},{"quotaFieldName":"timestamp","defaultValue":0,"extractValueJsonPath":"$.timestamp","jsonLogFilters":[],"valueEnum":"quotaLongValueExtractFromLog","cacheData":false,"expireSeconds":1209600}],"reportDefaultValues":{"bts":{"versionid":"_skip","planid":"_skip","bucketid":"_skip"},"good_cli_uv":"_skip","good_order_num":0,"good_cli_pv":0,"sales_amount":0,"good_cart_num":0,"good_paid_num":0,"good_cart_uv":"_skip","gmv":0,"search_rec_uv":"_skip","good_exp_uv":"_skip","pay_uv":"_skip","specimen":"_skip","search_rec_pv":0,"good_order_uv":"_skip","good_exp_pv":0,"timestamp":0}}' http://localhost:38195/order/json
```

# GB 葡萄牙支付实验报表
topic : dy_gb_pt_pay_report <br>
